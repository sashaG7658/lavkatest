name: Save New Order

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  repository_dispatch:
    types: [new_order_event]

jobs:
  process-order:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Process Order
      env:
        ORDER_JSON: '${{ toJson(github.event.client_payload) }}'
      run: |
        # –°–æ–∑–¥–∞–µ–º Node.js —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞
        cat > process_order.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        try {
          // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
          const orderData = JSON.parse(process.env.ORDER_JSON || '{}');
          
          console.log('üì¶ –ü–æ–ª—É—á–µ–Ω –∑–∞–∫–∞–∑:', orderData.orderNumber);
          
          // –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∑–∞–∫–∞–∑–æ–≤
          const ordersPath = path.join(__dirname, 'orders.json');
          
          // –ß–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–∫–∞–∑—ã
          let orders = [];
          if (fs.existsSync(ordersPath)) {
            const content = fs.readFileSync(ordersPath, 'utf8');
            orders = JSON.parse(content || '[]');
            if (!Array.isArray(orders)) {
              orders = [];
            }
          }
          
          // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –∑–∞–∫–∞–∑–∞
          const fullOrder = {
            id: 'order_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            ...orderData,
            savedAt: new Date().toISOString(),
            status: 'pending',
            workflowRun: process.env.GITHUB_RUN_ID || 'manual'
          };
          
          // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
          orders.unshift(fullOrder);
          
          // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 1000 –∑–∞–∫–∞–∑–æ–≤
          if (orders.length > 1000) {
            orders = orders.slice(0, 1000);
          }
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º
          fs.writeFileSync(ordersPath, JSON.stringify(orders, null, 2));
          
          console.log('‚úÖ –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
          console.log(`üìä –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: ${orders.length}`);
          console.log(`üÜî –ù–æ–º–µ—Ä: ${orderData.orderNumber}`);
          console.log(`üí∞ –°—É–º–º–∞: ${orderData.total} —Ä—É–±.`);
          
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          process.stdout.write(JSON.stringify({
            success: true,
            message: 'Order saved successfully',
            orderId: fullOrder.id,
            totalOrders: orders.length
          }));
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞:', error);
          process.stdout.write(JSON.stringify({
            success: false,
            error: error.message
          }));
          process.exit(1);
        }
        EOF
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç
        node process_order.js
        
    - name: Commit changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add orders.json
        git commit -m "üì¶ –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–∫–∞–∑ ${{ github.event.client_payload.orderNumber || '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑' }}"
        git push
